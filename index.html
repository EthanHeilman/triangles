<!DOCTYPE html>
<html>
<body>


<div id="cyber" style="border : solid 20x #ff0000; background : #000000; color : #ffffff; padding : 4px; width : 100%; height : 850px; overflow-x: auto;">
	<canvas id="canvas" width="6000" height="850" style="border:0px solid #000000;">
	Your browser does not support the HTML5 canvas tag.
	</canvas>
</div>

<input type="button" onclick="processDowngrades()" value="Process Downgrades">


<div id="json-input">
	<textarea rows="15" cols="100">Put Json Here.</textarea>
</div>

Downgrades:<br>
<div id="downgrades-list"></div>



<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js"></script>


<script type="text/javascript">

var ip1 = new IP(120, 60, 0x00, 0x00); //0.240
var ip2 = new IP(120, 60, 0x00, 0x00); //0.240
// 120.60.128.0-120.60.128.0\10

var intervals = []; 
var downgrade =  new Interval(ip1, ip2, 8, "V2U");
intervals.push( downgrade );

var triIP = new IP(120, 0x00, 0x00, 0x00); //0   = 0000,0000

var triSlash = 8;


// var ip7 = new IP(0x45, 0xA0, 0x00, 0x00); //0.240
// var ip8 = new IP(0x45, 0xC0, 0x00, 0x00); //0.240

// var intervals = []; 
// var downgrade =  new Interval(ip7, ip8, 4, "V2U");
// intervals.push( downgrade );
// var downgrade =  new Interval(ip7, ip8, 5, "V2U");
// intervals.push( downgrade );
// var downgrade =  new Interval(ip7, ip8, 6, "V2U");
// intervals.push( downgrade );
// var downgrade =  new Interval(ip7, ip8, 7, "V2I");
// intervals.push( downgrade );
// var downgrade =  new Interval(ip7, ip8, 8, "U2I");
// intervals.push( downgrade );
// var downgrade =  new Interval(ip7, ip8, 9, "V2U");
// intervals.push( downgrade );
// var downgrade =  new Interval(ip7, ip8, 10, "V2I");
// intervals.push( downgrade );
// var downgrade =  new Interval(ip7, ip8, 11, "U2I");
// intervals.push( downgrade );
// var downgrade =  new Interval(ip7, ip8, 12, "V2U");
// intervals.push( downgrade );
// var downgrade =  new Interval(ip7, ip8, 13, "V2I");
// intervals.push( downgrade );
// var downgrade =  new Interval(ip7, ip8, 14, "U2I");
// intervals.push( downgrade );
// var downgrade =  new Interval(ip7, ip8, 15, "V2U");
// intervals.push( downgrade );

// function Interval(startAddr, stopAddr, slash, type){
// 	this.a = startAddr;
// 	this.z = stopAddr;
// 	this.slash = slash;
// 	this.type = type;

// 	console.assert( type == "V2U" || type == "U2I" || type == "V2I");
// }

// function IP(x1, x2, x3, x4){
// 	this.x1 = x1;
// 	this.x2 = x2;
// 	this.x3 = x3;
// 	this.x4 = x4;

// 	this.slash24Int = function(){
// 		return Math.pow(this.x2,2)+this.x3;
// 	};
// }

function getPrefixIntervalSet(downgrade){

	var effects = downgrade["EFFECT"];
	var type = downgrade["CHANGE"].replace("+", "").replace("-", "");
	var intervals = []

	for (slash in effects){
		var effect = effects[slash];
		var range = effect.split(" ")[0];

		if (range != "empty"){

			var aStr = range.split("-")[0].replace("[", "");
			var bStr = range.split("-")[1].replace("]", "");

			var ipA = new IP(aStr.split(".")[0], aStr.split(".")[1], aStr.split(".")[2], aStr.split(".")[3]);
			var ipB = new IP(bStr.split(".")[0], bStr.split(".")[1], bStr.split(".")[2], bStr.split(".")[3]);

			intervals.push( new Interval(ipA, ipB, slash, type) );
		}
	}
	return intervals;
}

function processDowngrades(){

	var json = '[{"CHANGE":"-V2I", "ROA":{"AS" :"001", "PREFIX":"120.60.128.0/25-27", "PATH":"path3"}, "EFFECT":["empty /0", "empty /1", "empty /2", "empty /3", "empty /4", "empty /5", "empty /6", "empty /7", "empty /8", "empty /9", "[120.60.128.0-120.60.128.0] /10", "[120.60.0.0-120.60.192.64] /11", "[120.60.128.0-120.60.128.64] /12", "empty /13", "empty /14", "empty /15", "empty /16", "empty /17", "empty /18", "empty /19", "empty /20", "empty /21", "empty /22", "empty /23", "empty /24", "[120.60.128.0-120.60.128.0] /25", "[120.60.128.0-120.60.128.64] /26", "[120.60.128.0-120.60.128.96] /27", "empty /28", "empty /29", "empty /30", "empty /31", "empty /32"]},{"CHANGE":"-V2U", "ROA":{"AS" :"001", "PREFIX":"120.60.128.0/25-27", "PATH":"path3"}, "EFFECT":["empty /0", "empty /1", "empty /2", "empty /3", "empty /4", "empty /5", "empty /6", "empty /7", "empty /8", "empty /9", "[121.60.128.0-120.60.128.0] /10", "[121.60.128.0-120.60.128.64] /11", "[121.60.128.0-120.60.128.64] /12", "empty /13", "empty /14", "empty /15", "empty /16", "empty /17", "empty /18", "empty /19", "empty /20", "empty /21", "empty /22", "empty /23", "empty /24", "[120.60.128.0-120.60.128.0] /25", "[120.60.128.0-120.60.128.64] /26", "[120.60.128.0-120.60.128.96] /27", "empty /28", "empty /29", "empty /30", "empty /31", "empty /32"]}]';

	var input = jQuery.parseJSON( json );

	var intervals = [];
	var triIP = null;
	var triSlash = 8;

	for (d in input){
		var downgrade = input[d];
		var intervalSet = getPrefixIntervalSet(downgrade);
		$("#downgrades-list")[0].innerHTML += downgrade["CHANGE"]+","+downgrade["ROA"]["AS"]+","+downgrade["ROA"]["PATH"]+"<br>";


		for (i in intervalSet){
			var interval = intervalSet[i];

			if (triIP == null) {
				triIP = new IP(interval.a.x1, 0, 0, 0);
			}

			$("#downgrades-list")[0].innerHTML += "----------> "+interval.toString()+"<br>";

			intervals.push(interval);
		}

	}

	console.log(triIP.x1);
	console.log(intervals);
	display(intervals, triIP, triSlash);
}

	


$("#cyber").scrollLeft(2500);

var colorV2U = "#6FFF00";
var colorU2I = "#FE0001";
var colorV2I = "#FFFF00";
var lineColor= "#CC00CC";
var bgColor = "#303032";

function P(x, y){
	this.x = x;
	this.y = y;
}

function Triangle(top, left, right){
	this.top = top;
	this.left = left;
	this.right = right;

	this.m = function(side){
		rise = this[side].y - this.top.y;
		run = this[side].x - this.top.x;
		return rise/run;
	};

	// Right slope
	this.right_m = function(){ return this.m("right"); };

	// Left slope
	this.left_m = function(){ return this.m("left"); };

	this.b = function(side){
		return this[side].y - this.m(side)*this[side].x;
	};

	// Right y-intercept
	this.right_b = function(){ return this.b("right"); };

	// left y-intercept
	this.left_b = function(){ return this.b("left"); };


	this.inner = function(height){
		var bottom_x = this.left.x + Math.abs(this.left.x - this.right.x)/2;
		var bottom_y = this.right.y;

		var from_peak_y = this.top.y + height;

		var isect_left_x = (from_peak_y - this.left_b() )/this.left_m(); 
		if ( ! isFinite( this.left_m() ) ) isect_left_x = this.top.x;


		var isect_right_x =(from_peak_y - this.right_b() )/this.right_m(); 
		if ( ! isFinite( this.right_m() ) ) isect_right_x = this.top.x;


		var left = new P(isect_left_x, from_peak_y);
		var right = new P(isect_right_x, from_peak_y);
		var bottom = new P(bottom_x, bottom_y);

		return new Triangle(bottom, left, right);
	}

	this.split = function(height){
		var inner = this.inner(height);

		var left_t = new Triangle(inner.left, this.left, inner.top);
		var right_t = new Triangle(inner.right, inner.top, this.right);

		return [left_t, right_t]
	}
}


function Render(){
	this.ctx = document.getElementById('canvas').getContext('2d');

	this.ctx.fillStyle   = bgColor; // set canvas background color
	this.ctx.fillRect  (0,   0, 6000, 850);  // now fill the canvas

	this.drawTriangleOutline = function(t){
		var ctx = this.ctx;

		ctx.strokeStyle = lineColor;//"red";
		ctx.beginPath();
		ctx.moveTo(t.top.x, t.top.y);
		ctx.lineTo(t.left.x, t.left.y);
		ctx.lineTo(t.right.x, t.right.y);

		ctx.lineTo(t.top.x, t.top.y);
		ctx.stroke();
		//ctx.fill();
	};

	this.drawTriangleFill = function(t, color){
		var ctx = this.ctx;

		ctx.fillStyle = color;//"red";
		ctx.beginPath();
		ctx.moveTo(t.top.x, t.top.y);
		ctx.lineTo(t.left.x, t.left.y);
		ctx.lineTo(t.right.x, t.right.y);

		ctx.lineTo(t.top.x, t.top.y);
		//ctx.stroke();
		ctx.fill();
	};

	this.drawCircleFill = function(point, color){
		var ctx = this.ctx;
		var radius = 2;

		ctx.beginPath();
		ctx.arc(point.x, point.y, radius, 0, 2 * Math.PI, false);
		ctx.fillStyle = color;
		ctx.fill();
		ctx.lineWidth = 1;
		ctx.strokeStyle = color;
		ctx.stroke();
	};



	this.drawCircleOutline =  function(point){
		var ctx = this.ctx;

		var radius = 2;

		ctx.beginPath();
		ctx.arc(point.x, point.y, radius, 0, 2 * Math.PI, false);

		ctx.lineWidth = 1;
		ctx.strokeStyle = color;
		ctx.stroke();
	};
}


function buildTriangles(){
	var y_step = 50;
	//var max_depth = 8;
	var max_depth = 16;
	var t_height = y_step*max_depth;
	var width = 100;
	var t_side_len = Math.sqrt( width*3/4*Math.pow(t_height,2) );
	var x_trans = 0;
	var y_trans = 50;

	var t = new Triangle( new P(t_side_len/2 +x_trans, y_trans), new P(0+x_trans,t_height+y_trans), new P(t_side_len+x_trans, t_height+y_trans) );


	var stack = []
	stack.push(t);

	var triangles = [];

	for(var level = 0; level < max_depth; level+=1){

		var new_stack = [];
		while(stack.length > 0){
			var t = stack.shift();

			var scaling_factor = 1;
			//var scaling_factor = (level+1)/2.5; //can not be zero
			
			var inner = t.inner(y_step/(scaling_factor));
			var drawable_triangle =  new Triangle(t.top ,inner.left, inner.right);

			triangles.push(drawable_triangle); //save for later

			new_stack.push.apply(new_stack, t.split( y_step/(scaling_factor) ) );
		}

		stack.push.apply(stack, new_stack);
	}

	return triangles;
}

function Interval(startAddr, stopAddr, slash, type){
	this.a = startAddr;
	this.z = stopAddr;
	this.slash = slash;
	this.type = type;

	console.assert( type == "V2U" || type == "U2I" || type == "V2I");

	this.toString = function(){
		return this.a.toString()+"-"+this.z.toString()+"\\"+this.slash;
	};
}

function IP(x1, x2, x3, x4){
	this.x1 = x1;
	this.x2 = x2;
	this.x3 = x3;
	this.x4 = x4;

	this.slash24Int = function(){
		return Math.pow(this.x2,2)+this.x3;
	};

	this.toString = function(){
		return this.x1+"."+this.x2+"."+this.x3+"."+this.x4;
	};
}


function getQueryString(){
	return location.search;
}


function computeWindow(newDowngrades, ip, slash){
	var downgrades = newDowngrades

	//Vet Downgrades
	// for(var d in newDowngrades){
	// 	var downgrade = newDowngrades[d];
	// 	if (slash <= downgrade.slash && downgrade.slash <= maxlen){
	// 		downgrades.push(downgrades);
	// 	}
	// }

	var w = []
	var ds = [];

	depth = 16;//maxlen-slash;

	for (var level = 0; level < depth; level++){
		var mask = (0xFFFF ^ (0xFFFF >> level));

		// This slash if block is so janky, will fix later
		// if (slash == 0) var node = ip.x1 & mask;
		// if (slash == 8) var node = ip.x2 & mask;
		// if (slash == 16) var node = ip.x3 & mask;
		// if (slash == 24) var node = ip.x4 & mask;

		var node = ip.slash24Int() & mask;

		var inc = 0x10000 >> level;
		console.log(level);

		for (var i = 0; i < Math.pow(2, level); i++){
			//console.log( node );
			var color = null;

			for(var d in downgrades){

				var downgrade = downgrades[d];

				if (! (downgrade.a.x1 <= ip.x1 && ip.x1 <= downgrade.z.x1) ) continue;

				var startOctet = downgrade.a.slash24Int() & mask;
				var endOctet = downgrade.z.slash24Int() & mask;

				if ( downgrade.slash == (level+slash) ){
				 	if( startOctet <= node  && node <= endOctet ){
						color = downgrade.type;
						console.log("^-^");
					}
				}
			}	
			w.push(color);

			node = node + inc;
		}
	}

	return w;
}

//var triIP = new IP(0x00, 0x00, 0x00, 0x00); //0   = 0000,0000
// var triIP = new IP(120, 0x00, 0x00, 0x00); //0   = 0000,0000

// var triDepth = 0;
// var triSlash = 8+triDepth;


// var ip1 = 0x80*Math.pow(2, 12)+0x00*Math.pow(2, 8)+0x00*Math.pow(2, 4)+0x00*Math.pow(2, 0); //128.0.0.0
// var ip2 = 0xC0*Math.pow(2, 12)+0x00*Math.pow(2, 8)+0x00*Math.pow(2, 4)+0x00*Math.pow(2, 0); //192.0.0.0
// var ip3 = 0x00*Math.pow(2, 12)+0x00*Math.pow(2, 8)+0x00*Math.pow(2, 4)+0x00*Math.pow(2, 0); //0.0.0.0
var ip1 = new IP(0x00, 0x00, 0x00, 0x00);; //128 = 1000,0000
var ip2 = new IP(0xF0, 0xC0, 0x00, 0x00);; //192 = 1100,0000

var ip3 = new IP(0x20, 0x00, 0x00, 0x00);
var ip4 = new IP(0x60, 0x00, 0x00, 0x00);

var ip5 = new IP(0x00, 0x00, 0x00, 0x00);

var ip6 = new IP(0x00, 0xF0, 0x00, 0x00); //0.240




var ip9 = new IP(0x00, 0x00, 0x00, 0x00); //0.240
var ip10 = new IP(0xFF, 0xC1, 0x00, 0x00); //255.128


// var downgrades2 = [];
// var downgrade =  new Interval(ip1, ip2, 2, "V2U");
// downgrades2.push( downgrade );
// var downgrade =  new Interval(ip3, ip4, 3, "V2I");
// downgrades2.push( downgrade );
// var downgrade =  new Interval(ip5, ip5, 0, "U2I");
// downgrades2.push( downgrade );
// var downgrade =  new Interval(ip5, ip6, 9, "U2I");
// downgrades2.push( downgrade );

// var downgrade =  new Interval(ip7, ip8, 13, "U2I");
// downgrades2.push( downgrade );

// var downgrade =  new Interval(ip9, ip10, 15, "V2I");
// downgrades2.push( downgrade );
//downgrades2

display(intervals, triIP, triSlash);


function display(intervals, triIP, triSlash){
	//console.log(intervals);
	w = computeWindow(intervals, triIP, triSlash);

	//console.log(w);

	var r = new Render();
	var triangles = buildTriangles();

	var triNum = 0;

	// console.log(w.length);
	// console.log(triangles);
	console.log(w[w.length-1])

	for (var t in w){

		// console.log(t);
		// console.log(downgrade.prefix);

		if (w[triNum] == "V2U"){
			console.assert(triangles[t]!=null);
			r.drawTriangleFill(triangles[t], colorV2U);

		} else 	if (w[triNum] == "U2I"){
			console.assert(triangles[t]!=null);

			r.drawTriangleFill(triangles[t], colorU2I);
		} else 	if (w[triNum] == "V2I"){
			console.assert(triangles[t]!=null);
			r.drawTriangleFill(triangles[t], colorV2I);

		} else {
			console.assert(triangles[t]!=null)
			r.drawTriangleOutline(triangles[t] );
		}	

		//r.drawCircleFill( triangles[t].top, "grey" );

		triNum++;
	} 

}

</script>


</body>
</html>
