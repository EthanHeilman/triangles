<!DOCTYPE html>
<html>
<body>



<div id="json-input-div">
	Octet:  <textarea id="octet" rows="1" cols="5" style="width : 5%"></textarea>
	<textarea id="json-downgrades-input" rows="1" cols="100" style="width : 80%">
{"CHANGE":"+U2I", "ROA":{"AS":6128, "PREFIX":"173.251.0.0/17-24", "PATH":"/research/bgp_analysis/roa_fetch/trunk/rcynic/archive/old/2013_12_13_02_06_46_1386918406/authenticated/rpki.arin.net/repository/arin-rpki-ta/5e4a23ea-e80a-403e-b08c-2171da2157d3/2a246947-2d62-4a6c-ba05-87187f0099b2/e68161a4-2ddf-4c1f-b8ef-ce2744b60852/0350487d-8749-33ed-b38c-d969eb1fbf3f.roa"}, "EFFECT":["empty /0", "empty /1", "empty /2", "empty /3", "empty /4", "empty /5", "empty /6", "empty /7", "empty /8", "empty /9", "empty /10", "empty /11", "empty /12", "empty /13", "empty /14", "empty /15", "empty /16", "[173.251.0.0-173.251.0.0] /17", "[173.251.0.0-173.251.64.0] /18", "[173.251.0.0-173.251.96.0] /19", "[173.251.0.0-173.251.112.0] /20", "[173.251.0.0-173.251.120.0] /21", "[173.251.0.0-173.251.124.0] /22", "[173.251.0.0-173.251.126.0] /23", "[173.251.0.0-173.251.127.0] /24", "[173.251.0.0-173.251.127.128] /25", "[173.251.0.0-173.251.127.192] /26", "[173.251.0.0-173.251.127.224] /27", "[173.251.0.0-173.251.127.240] /28", "[173.251.0.0-173.251.127.248] /29", "[173.251.0.0-173.251.127.252] /30", "[173.251.0.0-173.251.127.254] /31", "[173.251.0.0-173.251.127.255] /32"], "EXCEPT":{"3320":["empty /0", "empty /1", "empty /2", "empty /3", "empty /4", "empty /5", "empty /6", "empty /7", "empty /8", "empty /9", "empty /10", "empty /11", "empty /12", "empty /13", "empty /14", "empty /15", "empty /16", "[173.251.0.0-173.251.0.0] /17", "[173.251.0.0-173.251.64.0] /18", "[173.251.0.0-173.251.96.0] /19", "[173.251.0.0-173.251.112.0] /20", "[173.251.0.0-173.251.120.0] /21", "[173.251.0.0-173.251.124.0] /22", "[173.251.0.0-173.251.126.0] /23", "[173.251.0.0-173.251.127.0] /24", "[173.251.0.0-173.251.127.128] /25", "[173.251.0.0-173.251.127.192] /26", "[173.251.0.0-173.251.127.224] /27", "[173.251.0.0-173.251.127.240] /28", "[173.251.0.0-173.251.127.248] /29", "[173.251.0.0-173.251.127.252] /30", "[173.251.0.0-173.251.127.254] /31", "[173.251.0.0-173.251.127.255] /32"]}}
	</textarea>
	<textarea id="json-route-input" rows="1" cols="100" style="width : 100%">
{"PREFIX":"173.251.0.0/17", "AS":"6128", "VALID":"TRUE"}
{"PREFIX":"173.251.91.0/24", "AS":"53725", "VALID":"FALSE"}
{"PREFIX":"173.251.73.0/24", "AS":"53651", "VALID":"FALSE"}
{"PREFIX":"173.251.68.0/24", "AS":"62641", "VALID":"FALSE"}
{"PREFIX":"173.251.64.0/24", "AS":"62641", "VALID":"FALSE"}
{"PREFIX":"173.251.60.0/24", "AS":"16884", "VALID":"FALSE"}
{"PREFIX":"173.251.54.0/24", "AS":"22225", "VALID":"FALSE"}
{"PREFIX":"173.251.51.0/24", "AS":"13599", "VALID":"FALSE"}
{"PREFIX":"173.251.43.0/24", "AS":"18914", "VALID":"FALSE"}
{"PREFIX":"173.251.39.0/24", "AS":"15312", "VALID":"FALSE"}
{"PREFIX":"173.251.30.0/24", "AS":"11737", "VALID":"FALSE"}
{"PREFIX":"173.251.28.0/24", "AS":"14564", "VALID":"FALSE"}
{"PREFIX":"173.251.19.0/24", "AS":"32696", "VALID":"FALSE"}
{"PREFIX":"173.251.112.0/24", "AS":"53751", "VALID":"FALSE"}
{"PREFIX":"173.251.111.0/24", "AS":"53475", "VALID":"FALSE"}
{"PREFIX":"173.251.110.0/24", "AS":"62751", "VALID":"FALSE"}
	</textarea>
</div>
<input type="button" onclick="processDowngrades()" value="Process Downgrades" style="width : 100%">



<div id="cyber" style="border : solid 0x #ff0000; background : #303032; color : #303032; padding : 4px; width : 100%; height : 700px; overflow-x: auto;">
	<center>
	<canvas id="canvas" width="1400" height="700" style="border:0px solid #303032;">
	Your browser does not support the HTML5 canvas tag.
	</canvas>
	</center>
</div>




<table cellpadding="0" cellspacing="0" border="0" class="display" id="downgrades-table"></table>

<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="lib/jquery.dataTables.css">
 
<!-- jQuery -->
<script type="text/javascript" charset="utf8" src="lib/jquery-1.8.2.min.js"></script>
 
<!-- DataTables -->
<script type="text/javascript" charset="utf8" src="lib/jquery.dataTables.min.js"></script>


<script type="text/javascript">
	



$("#cyber").scrollLeft(2000);

var colorV2U = "#6FFF00";
var colorU2I = "#FE0001";
var colorV2I = "#FFFF00";
var lineColor= "#CC00CC";
var bgColor = "#303032";

function P(x, y){
	this.x = x;
	this.y = y;
}

function Triangle(top, left, right){
	this.top = top;
	this.left = left;
	this.right = right;

	// Right slope
	this.right_m = function(){ 
		rise = this.right.y - this.top.y;
		run = this.right.x - this.top.x;
		return rise/run;
	};

	// Left slope
	this.left_m = function(){ 
		rise = this.left.y - this.top.y;
		run = this.left.x - this.top.x;
		return rise/run;
	};

	// Right y-intercept
	this.right_b = function(){ return this.right.y - this.right_m()*this.right.x; };

	// left y-intercept
	this.left_b = function(){ return this.left.y - this.left_m()*this.left.x; };


	this.inner = function(height){
		var bottom_x = this.left.x + Math.abs(this.left.x - this.right.x)/2;
		var bottom_y = this.right.y;

		var from_peak_y = this.top.y + height;

		var isect_left_x = (from_peak_y - this.left_b() )/this.left_m(); 
		if ( ! isFinite( this.left_m() ) ) isect_left_x = this.top.x;


		var isect_right_x =(from_peak_y - this.right_b() )/this.right_m(); 
		if ( ! isFinite( this.right_m() ) ) isect_right_x = this.top.x;


		var left = new P(isect_left_x, from_peak_y);
		var right = new P(isect_right_x, from_peak_y);
		var bottom = new P(bottom_x, bottom_y);

		return new Triangle(bottom, left, right);
	}

	this.split = function(height){
		var inner = this.inner(height);

		var left_t = new Triangle(inner.left, this.left, inner.top);
		var right_t = new Triangle(inner.right, inner.top, this.right);

		return [left_t, right_t]
	}
}


function Render(){
	this.ctx = document.getElementById('canvas').getContext('2d');

	var xWidth = 1400;
	var yHeight = 700;

	this.ctx.fillStyle   = bgColor; // set canvas background color
	this.ctx.fillRect(0,   0, xWidth, yHeight);  // now fill the canvas


	this.drawLegend = function(){
		var legendSize = 20;
		var legendYMargin = 20;
		var legendXOffset = xWidth/2 - 500;
		var textYMargin= 35;
		var fontsize = 18;

		this.ctx.fillStyle=colorV2U;
		this.ctx.fillRect(legendXOffset,legendYMargin,legendSize,legendSize);

		this.ctx.font=fontsize.toString()+"px Arial";
		this.ctx.fillText(" - Valid to Invalid", legendXOffset + legendSize, textYMargin);

		this.ctx.fillStyle=colorU2I;
		this.ctx.fillRect(legendXOffset + 170,legendYMargin,legendSize,legendSize);

		this.ctx.font=fontsize.toString()+"px Arial";
		this.ctx.fillText(" - Unknown to Invalid", legendXOffset + legendSize + 170, textYMargin);

		this.ctx.fillStyle=colorV2I;
		this.ctx.fillRect(legendXOffset + 375,legendYMargin,legendSize,legendSize);

		this.ctx.font=fontsize.toString()+"px Arial";
		this.ctx.fillText(" - Valid to Invalid", legendXOffset + legendSize + 375, textYMargin);
	}


	this.drawTriangleOutline = function(t){
		var ctx = this.ctx;

		ctx.strokeStyle = lineColor;//"red";
		ctx.beginPath();
		ctx.moveTo(t.top.x, t.top.y);
		ctx.lineTo(t.left.x, t.left.y);
		ctx.lineTo(t.right.x, t.right.y);

		ctx.lineTo(t.top.x, t.top.y);
		ctx.stroke();
	};

	this.drawTriangleFill = function(t, color){
		var ctx = this.ctx;

		ctx.fillStyle = color;//"red";
		ctx.beginPath();
		ctx.moveTo(t.top.x, t.top.y);
		ctx.lineTo(t.left.x, t.left.y);
		ctx.lineTo(t.right.x, t.right.y);

		ctx.lineTo(t.top.x, t.top.y);
		ctx.fill();
	};

	this.drawCircleFill = function(point, color){
		var ctx = this.ctx;
		var radius = 10;

		ctx.beginPath();
		ctx.arc(point.x, point.y, radius, 0, 2 * Math.PI, false);
		ctx.fillStyle = color;
		ctx.fill();
		ctx.lineWidth = 2;
		ctx.strokeStyle = "black";
		ctx.stroke();
	};



	this.drawCircleOutline =  function(point, color){
		var ctx = this.ctx;

		var radius = 2;

		ctx.beginPath();
		ctx.arc(point.x, point.y, radius, 0, 2 * Math.PI, false);

		ctx.lineWidth = 1;
		ctx.strokeStyle = color;
		ctx.stroke();
	};
}


function buildTriangles(){
	var y_step = 35;
	//var max_depth = 8;
	var max_depth = 17;
	var t_height = y_step*max_depth;
	var width = 5;
	var t_side_len = Math.sqrt( width*3/4*Math.pow(t_height,2) );
	var x_trans = 50;
	var y_trans = 50;

	var t = new Triangle( new P(t_side_len/2 +x_trans, y_trans), new P(0+x_trans,t_height+y_trans), new P(t_side_len+x_trans, t_height+y_trans) );


	var stack = []
	stack.push(t);

	var triangles = [];

	for(var level = 0; level < max_depth; level+=1){

		var new_stack = [];
		while(stack.length > 0){
			var t = stack.shift();

			var scaling_factor = 1;
			//var scaling_factor = (level+1)/2.5; //can not be zero
			
			var inner = t.inner(y_step/(scaling_factor));
			var drawable_triangle =  new Triangle(t.top ,inner.left, inner.right);

			triangles.push(drawable_triangle); //save for later

			var new_tris = t.split( y_step/(scaling_factor) );

			for (i in new_tris){ new_stack.push(new_tris[i]); }
		}
		stack = new_stack;

	}

	return triangles;
}

function Interval(startAddr, stopAddr, slash, type){
	this.a = startAddr;
	this.z = stopAddr;
	this.slash = slash;
	this.type = type;

	console.assert( type == "V2U" || type == "U2I" || type == "V2I");

	this.toString = function(){
		return this.a.toString()+"-"+this.z.toString()+"\\"+this.slash;
	};
}

function IP(x1, x2, x3, x4){
	this.x1 = Number(x1);
	this.x2 = Number(x2);
	this.x3 = Number(x3);
	this.x4 = Number(x4);

	this.slash24Int = function(){
		return 256*this.x2+this.x3;
	};

	this.toString = function(){
		return this.x1+"."+this.x2+"."+this.x3+"."+this.x4;
	};
}


function getQueryString(){
	return location.search;
}


function computeWindow(newDowngrades, routes, ip, slash){
	var downgrades = newDowngrades

	var w = []
	var ds = [];

	depth = 17;//maxlen-slash;

	for (var level = 0; level < depth; level++){
		var mask = (0xFFFF ^ (0xFFFF >> level));

		var node = ip.slash24Int() & mask;

		var inc = 0x10000 >> level;

		for (var i = 0; i < Math.pow(2, level); i++){
			var color = null;
			var circle = null;

			for (var r in routes){
				var route = routes[r];

				if ( route.slash == (level+slash) ){

					var octet = route.ip.slash24Int() & mask;

					//TODO: add code to edge case non-octet prefixes
					if ( octet == node ){
						circle = route.valid;
					}

				}

			}

			for(var d in downgrades){

				var downgrade = downgrades[d];

				if (! (downgrade.a.x1 <= ip.x1 && ip.x1 <= downgrade.z.x1) ) continue;

				var startOctet = downgrade.a.slash24Int() & mask;
				var endOctet = downgrade.z.slash24Int() & mask;

				if ( downgrade.slash == (level+slash) ){
					
					//edge cases where the downgrade starts outside the draw window
					if ( downgrade.a.x1 < ip.x1 && ip.x1 < downgrade.z.x1 ) color = downgrade.type;
					if ( downgrade.a.x1 < ip.x1 && node <= endOctet ) color = downgrade.type;
					else if ( ip.x1 < downgrade.z.x1 && startOctet <= node ) color = downgrade.type;

					// downgrade x1 = ip x1
				 	else if( startOctet <= node  && node <= endOctet ) color = downgrade.type;
				}
			}	
			w.push( [color,circle] );

			node = node + inc;
		}
	}

	return w;
}


function display(intervals, routes, triIP, triSlash){

	var w = computeWindow(intervals, routes, triIP, triSlash);

	this.ctx = document.getElementById('canvas').getContext('2d');

	var r = new Render();
	r.drawLegend();
	var triangles = buildTriangles();

	var triNum = 0;

	for (var t in w){

		if (w[triNum][0] == "V2U"){
			console.assert(triangles[t]!=null);
			r.drawTriangleFill(triangles[t], colorV2U);

		} else 	if (w[triNum][0] == "U2I"){
			console.assert(triangles[t]!=null);
			r.drawTriangleFill(triangles[t], colorU2I);
		} else 	if (w[triNum][0] == "V2I"){
			console.assert(triangles[t]!=null);
			r.drawTriangleFill(triangles[t], colorV2I);

		} else {
			console.assert(triangles[t]!=null)
			r.drawTriangleOutline(triangles[t] );
		}	

		if (w[triNum][1] != null){
			if ( w[triNum][1] == "TRUE" )
				r.drawCircleFill( triangles[t].top, "green" );
			else
				r.drawCircleFill( triangles[t].top, "blue" );
		}

		triNum++;
	} 
}

function getPrefixIntervalSet(downgrade){

	var effects = downgrade["EFFECT"];
	var type = downgrade["CHANGE"].replace("+", "").replace("-", "");
	var intervals = []

	for (i in effects){

		var effect = effects[i];
		var slash = parseInt(effect.split("/")[1])-8;
		var range = effect.split(" ")[0];

		if (range != "empty"){

			var aStr = range.split("-")[0].replace("[", "");
			var bStr = range.split("-")[1].replace("]", "");
			// var ipA = new IP(Number(aStr.split(".")[0]), Number(aStr.split(".")[1]), Number(aStr.split(".")[2]), Number(aStr.split(".")[3]));
			// var ipB = new IP(Number(bStr.split(".")[0]), Number(bStr.split(".")[1]), Number(bStr.split(".")[2]), Number(bStr.split(".")[3]));

			var ipA = new IP(Number(aStr.split(".")[1]), Number(aStr.split(".")[2]), Number(aStr.split(".")[3]), Number(0));
			var ipB = new IP(Number(bStr.split(".")[1]), Number(bStr.split(".")[2]), Number(bStr.split(".")[3]), Number(0));

			intervals.push( new Interval(ipA, ipB, slash, type) );
		}
	}
	return intervals;
}

var intervals = []; //TODO: turn this into a class variable
var triSlash = 8;

function intervalClicked( rootOctet ){
	var triIP = new IP(rootOctet,  0, 0, 0);
			
	display(intervals, triIP, triSlash);
}

function isBlank( str ){ return str.trim().length == 0; }

function displayTable( data ){
		$('#downgrades-table').dataTable( {
        "aaData": data,
        "aoColumns": [
            { "sTitle": "Downgrade Type", "sClass": "center", "sWidth":"5%" },
            { "sTitle": "Prefix",  "sWidth":"20%"},
            { "sTitle": "AS", "sClass": "center", "sWidth":"10%" },
            { "sTitle": "Path", "sWidth": "40%"},
        ],
        "bDestroy": true
    	} ); 

    	$('#downgrades-table').css('width', '100%');


}


function Route(jsonRoute){	
	this.slash = parseInt(jsonRoute['PREFIX'].split("/")[1])-8;
	var prefixStr = jsonRoute['PREFIX'].split("/")[0];


	this.ip = new IP(Number(prefixStr.split(".")[1]), Number(prefixStr.split(".")[2]), Number(prefixStr.split(".")[3]), Number(0));

	this.AS = jsonRoute['AS'];
	this.valid = jsonRoute['VALID'];
}


function processDowngrades(){

	var json = $("#json-downgrades-input").val().split("\n");

	var input = [];
	for( j in json ){		
		if( isBlank( json[j] ) ) continue;
		input.push( jQuery.parseJSON( json[j] ) );
	}


	intervals = [];
	var triIP = null;
	if ($("#octet").val() != "") triIP =  new IP(parseInt($("#octet").val()), 0, 0, 0);

	var tableOutput = [];

	for (d in input){
		var downgrade = input[d];
		var intervalSet = getPrefixIntervalSet(downgrade);

		for (i in intervalSet){
			var interval = intervalSet[i];
			var row = [downgrade["CHANGE"], interval.toString(), downgrade["ROA"]["AS"], downgrade["ROA"]["PATH"]];

			if (triIP == null) {
				triIP = new IP(interval.a.x1, 0, 0, 0);
			}

			tableOutput.push(row);
			intervals.push(interval);
		}

	}


	var json = $("#json-route-input").val().split("\n");
	var routes = []
	for( j in json ){		
		if( isBlank( json[j] ) ) continue;
		routes.push( new Route( jQuery.parseJSON( json[j] ) ) );
	}

	displayTable(tableOutput);
	display(intervals, routes, triIP, triSlash);
}

//var triangles = buildTriangles();
var start = Date.now();
processDowngrades();
var stop = Date.now();
console.log("time = "+(stop-start)/1000);


</script>


</body>
</html>
