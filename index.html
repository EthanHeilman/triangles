<!DOCTYPE html>
<html>
<body>

<canvas id="canvas" width="1200" height="800" style="border:1px solid #000000;">
Your browser does not support the HTML5 canvas tag.
</canvas>

<script type="text/javascript">

function P(x, y){
	this.x = x;
	this.y = y;
}


function Triangle(top, left, right){
	this.top = top;
	this.left = left;
	this.right = right;

	this.m = function(side){
		rise = this[side].y - this.top.y;
		run = this[side].x - this.top.x;
		return rise/run;
	};

	// Right slope
	this.right_m = function(){ return this.m("right"); };

	// Left slope
	this.left_m = function(){ return this.m("left"); };

	this.b = function(side){
		return this[side].y - this.m(side)*this[side].x;
	};

	// Right y-intercept
	this.right_b = function(){ return this.b("right"); };

	// left y-intercept
	this.left_b = function(){ return this.b("left"); };


	this.inner = function(height){
		var bottom_x = this.left.x + Math.abs(this.left.x - this.right.x)/2;
		var bottom_y = this.right.y;

		var from_peak_y = this.top.y + height;

		var isect_left_x = (from_peak_y - this.left_b() )/this.left_m(); 
		if ( ! isFinite( this.left_m() ) ) isect_left_x = this.top.x;


		var isect_right_x =(from_peak_y - this.right_b() )/this.right_m(); 
		if ( ! isFinite( this.right_m() ) ) isect_right_x = this.top.x;


		var left = new P(isect_left_x, from_peak_y);
		var right = new P(isect_right_x, from_peak_y);
		var bottom = new P(bottom_x, bottom_y);



		return new Triangle(bottom, left, right);
	}

	this.split = function(height){
		var inner = this.inner(height);

		var left_t = new Triangle(inner.left, this.left, inner.top);
		var right_t = new Triangle(inner.right, inner.top, this.right);

		return [left_t, right_t]
	}
}


function Render(){
	this.ctx = document.getElementById('canvas').getContext('2d');

	this.drawTriangleOutline = function(t){
		var ctx = this.ctx;

		//ctx.fillStyle = color;//"red";
		ctx.beginPath();
		ctx.moveTo(t.top.x, t.top.y);
		ctx.lineTo(t.left.x, t.left.y);
		ctx.lineTo(t.right.x, t.right.y);

		ctx.lineTo(t.top.x, t.top.y);
		ctx.stroke();
		//ctx.fill();
	};

	this.drawTriangleFill = function(t, color){
		var ctx = this.ctx;

		ctx.fillStyle = color;//"red";
		ctx.beginPath();
		ctx.moveTo(t.top.x, t.top.y);
		ctx.lineTo(t.left.x, t.left.y);
		ctx.lineTo(t.right.x, t.right.y);

		ctx.lineTo(t.top.x, t.top.y);
		ctx.stroke();
		ctx.fill();
	};

	this.drawCircleFill = function(point, color){
		var ctx = this.ctx;
		var radius = 2;

		ctx.beginPath();
		ctx.arc(point.x, point.y, radius, 0, 2 * Math.PI, false);
		ctx.fillStyle = color;
		ctx.fill();
		ctx.lineWidth = 1;
		ctx.strokeStyle = color;
		ctx.stroke();
	};



	this.drawCircleOutline =  function(point){
		var ctx = this.ctx;

		var radius = 2;

		ctx.beginPath();
		ctx.arc(point.x, point.y, radius, 0, 2 * Math.PI, false);

		ctx.lineWidth = 1;
		ctx.strokeStyle = color;
		ctx.stroke();
	};
}


function buildTriangles(){
	var y_step = 50;
	var max_depth = 8;
	var t_height = y_step*max_depth;
	var width = 10;
	var t_side_len = Math.sqrt( width*3/4*Math.pow(t_height,2) );
	var x_trans = 50;
	var y_trans = 50;

	var t = new Triangle( new P(t_side_len/2 +x_trans, y_trans), new P(0+x_trans,t_height+y_trans), new P(t_side_len+x_trans, t_height+y_trans) );


	var stack = []
	stack.push(t);

	var triangles = [];

	for(var level = 0; level < max_depth; level+=1){

		var new_stack = [];
		while(stack.length > 0){
			var t = stack.shift();

			var scaling_factor = 1;
			//var scaling_factor = (level+1)/2.5; //can not be zero
			
			var inner = t.inner(y_step/(scaling_factor));
			var drawable_triangle =  new Triangle(t.top ,inner.left, inner.right);

			triangles.push(drawable_triangle); //save for later

			new_stack.push.apply(new_stack, t.split( y_step/(scaling_factor) ) );
		}

		stack.push.apply(stack, new_stack);
	}

	return triangles;
}

function Downgrade(startAddr, stopAddr, slash, type){
	this.a = startAddr;
	this.z = stopAddr;
	this.slash = slash;
	this.type = type;

	console.assert( type == "V2U" || type == "U2I" || type == "V2I");

}


function getQueryString(){
	return location.search;
}


function computeWindow(newDowngrades, ip, slash, maxlen){
	var downgrades = newDowngrades

	//Vet Downgrades
	// for(var d in newDowngrades){
	// 	var downgrade = newDowngrades[d];
	// 	if (slash <= downgrade.slash && downgrade.slash <= maxlen){
	// 		downgrades.push(downgrades);
	// 	}
	// }

	var w = []
	var ds = [];

	depth = maxlen-slash;

	for (var level = 0; level < depth; level++){
		branches = [];

		var mask = (0xFF ^ (0xFF >> level));
		var node = ip & mask;
		var inc = 0x100 >> level;

		for (var i = 0; i < Math.pow(2, level); i++){
			//console.log( node );
			var color = null;

			for(var d in downgrades){
				var downgrade = downgrades[d];
				//console.log(downgrade+"A:"+downgrade.a+", B:"+downgrade.z+", node:"+node);

				if (downgrade.slash == (level+slash) && downgrade.a <= node  && node <= downgrade.z ){
					color = downgrade.type;
					console.log("^-^");
				}
			}	
			branches.push(color);
			w.push(color);

			node = node + inc;
		}
		ds.push(branches);
	}

	return w;
}

// var ip1 = 0x80*Math.pow(2, 12)+0x00*Math.pow(2, 8)+0x00*Math.pow(2, 4)+0x00*Math.pow(2, 0); //128.0.0.0
// var ip2 = 0xC0*Math.pow(2, 12)+0x00*Math.pow(2, 8)+0x00*Math.pow(2, 4)+0x00*Math.pow(2, 0); //192.0.0.0
// var ip3 = 0x00*Math.pow(2, 12)+0x00*Math.pow(2, 8)+0x00*Math.pow(2, 4)+0x00*Math.pow(2, 0); //0.0.0.0
var ip1 = 0x80; //128
var ip2 = 0xC0; //192
var ip3 = 0x00; //0

var downgrades2 = [];
var downgrade =  new Downgrade(ip1, ip2, 2, "V2U");
downgrades2.push( downgrade );
var downgrade =  new Downgrade(0x20, 0x60, 3, "V2I");
downgrades2.push( downgrade );
var downgrade =  new Downgrade(0x00, 0x00, 0, "U2I");
downgrades2.push( downgrade );

w = computeWindow(downgrades2, ip3, 0, 8);

//console.log(w);

var r = new Render();
var triangles = buildTriangles();

console.log(getQueryString());



// var downgrades = {};
// var downgrade =  new Downgrade(1, 1, "V2U");
// downgrades[ downgrade.prefix ] = downgrade;
// var downgrade =  new Downgrade(2, 1, "U2I");
// downgrades[ downgrade.prefix ] = downgrade;
// var downgrade =  new Downgrade(4, 1, "V2I");
// downgrades[ downgrade.prefix ] = downgrade;

console.log(w);
var triNum = 0;
for (var t in triangles){

	// console.log(t);
	// console.log(downgrade.prefix);

	if (w[triNum] == "V2U"){
		r.drawTriangleFill(triangles[t], "#848484");
	} else 	if (w[triNum] == "U2I"){
		r.drawTriangleFill(triangles[t], "#BDBDBD");
	} else 	if (w[triNum] == "V2I"){
		r.drawTriangleFill(triangles[t], "#2E2E2E");

	} else {
		r.drawTriangleOutline(triangles[t] );
	}

	r.drawCircleFill( triangles[t].top, "grey" );

	triNum++;
} 



</script>


</body>
</html>
